// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String   @unique
  firstName String?
  lastName  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reports     Report[]
  shareTokens ShareToken[]

  @@index([clerkId])
  @@index([email])
}

model Report {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String?
  summary     String?  @db.Text // AI-generated summary of report
  fileUrl     String
  fileType    String // 'pdf', 'image'
  publicId    String // Cloudinary public ID
  uploadedAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  vitals Vital[]
  sharedIn SharedReport[]

  @@index([userId])
  @@index([uploadedAt])
  @@index([fileType])
}

model Vital {
  id         String   @id @default(cuid())
  reportId   String
  vitalType  String 
  value      Float
  unit       String 
  recordedAt DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@index([vitalType])
  @@index([recordedAt])
}

model ShareToken {
  id             String   @id @default(cuid())
  token          String   @unique @default(cuid())
  userId         String
  sharedWithEmail String? // Email of specific user who can access this share
  expiresAt      DateTime
  isRevoked      Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  sharedReports SharedReport[]

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@index([sharedWithEmail])
}

model SharedReport {
  id           String @id @default(cuid())
  shareTokenId String
  reportId     String

  shareToken ShareToken @relation(fields: [shareTokenId], references: [id], onDelete: Cascade)
  report     Report     @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@unique([shareTokenId, reportId])
  @@index([shareTokenId])
  @@index([reportId])
}
